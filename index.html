<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <script>
      window.$ = window.jQuery = require('jquery');
      window.Bootstrap = require('bootstrap');
      require( 'datatables.net-bs4' )();
      const db = new Database('cookies.db', { verbose: console.log });
      var sql = 'CREATE TABLE cookies(creation_utc INTEGER NOT NULL,host_key TEXT NOT NULL,name TEXT NOT NULL,value TEXT NOT NULL,path TEXT NOT NULL,expires_utc INTEGER NOT NULL,is_secure INTEGER NOT NULL,is_httponly INTEGER NOT NULL,last_access_utc INTEGER NOT NULL,has_expires INTEGER NOT NULL DEFAULT 1,is_persistent INTEGER NOT NULL DEFAULT 1,priority INTEGER NOT NULL DEFAULT 1,encrypted_value BLOB DEFAULT \'\',samesite INTEGER NOT NULL DEFAULT -1,UNIQUE (host_key, name, path))';
      var sql2 = 'INSERT INTO cookies (creation_utc, host_key, name, value, path, expires_utc, is_secure, is_httponly, last_access_utc) VALUES (1, "hello", "hello", "hello", "hello", 1, 1, 1, 1)'
      var sql3 = 'SELECT host_key, name FROM cookies'
      console.log(db.exec(sql1));
      console.log(db.exec(sql2));
      var host_key = console.log(db.exec(sql3));
      document.getElementById('message').innerHTML = host_key;
    </script>
    
    
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/select/1.3.1/css/select.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.6.0/css/buttons.dataTables.min.css">


    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    
   
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.6.0/js/dataTables.buttons.min.js"></script>

    <!-- jQuery Modal -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
    <title>Cookie Monsterrr</title>
    <style>
      html, body {
        width: 100%;
        height: 100%;
      }

      body {
        overflow-x: hidden;
      }
      
      .vertScrollbar {
      position: relative;
      height: 800px;
      overflow: auto;
      }
      .detail {
        border-style: solid;
        border-color: grey;
        margin: 0em;
      }
      .detail p,b {
        margin: 0;
        padding: 0;
        font-size: 30px;
      }
      
      .new{
        padding: 0;
      }
      
      .modal {
        height: auto;
        overflow: auto;
      }
      
      .modal h2 {
        text-align: center;
      }

      tr.table-danger.selected td {
        background-color: #f36473!important;
      }
    </style>
    
    <nav id="mainNav" class="navbar navbar-expand-sm bg-dark navbar-dark">
      <a class="navbar-brand" href="#">Cookie Monsterrr</a>
      
      <!-- href contains a where the link goes to -->
      <ul class="navbar-nav">
        <!-- <li class="nav-item active">
          <a class="nav-link" href="sample.html">Active</a>
        </li> -->
        <li class="nav-item">
            <div id="button">
          <a class="nav-link" href="learn_more.html" target="_blank">Learn More</a>
            </div>
        </li>
        <li class="nav-item">
          <div id="button">
        <a class="nav-link" href="analyze.html" target="_blank">Analyze</a>
          </div>
      </li>
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/utk-cs/2019fall_ant-man/blob/master/README.md" target="_blank">Read Me</a>
        </li>
        <!-- <li class="nav-item">
          <a class="nav-link disabled" href="#">Disabled</a>
        </li> -->
      </ul>


    </nav>
  </head>
  <body>
    <div id="welcomeModal" class="modal">
      <h2>Loading... <span id="loadingProgress">0</span>%</h2>
      <!--<p>
        Hello, World! This is Cookie Monsterrr, a browser cookie managment tool.
        With this tool, you can browse, view, add, modify, our delete your browser cookies!
        This is an especially important thing to do.
        These days, websites track your every move with cookies that can tell them where you've been.
        But not all cookies are bad! Some of them simply keep you logged in after you click that checkbox.
        Some of them help websites know whether or not you've enabled their dark theme.
        That's why we've made this tool. We made it to give control back to you.
      </p>-->
      <div class="d-flex justify-content-center">
        <img id="loadingWelcome" src="cookie.gif" />
        <!--<a id="continueWelcome" href="#" class="btn btn-info" rel="modal:close">Continue</a>-->
      </div>
    </div>
    <div id="mainContent" class="row">
      <div id="cookieList" class="col-sm-6">
          <table id="cookies-dt" class="table table-striped table-bordered table-sm " cellspacing="0" width="100%">
              <thead>
                  <tr>
                      <th>Creation Date</th>
                      <th>Website</th>
                      <th>Name</th>
                      <th>Path</th>
                      <th>Value</th>
                      <th>Expiration Date</th>
                      <th>Last Access Date</th>
                      <th>Is Secure</th>
                      <th>Is Httponly</th>
                      <th>Has Expires</th>
                      <th>Is Persistent</th>
                      <th>Priority</th>
                      <th>Samesite</th>
                  </tr>
              </thead>
          </table>
      </div>
      <div id="cookieView" class="col-sm-6" style="overflow-x: auto;">
        <div class="row">
          <table id="detailedView" class="table table-striped" style="display: none;">
            <thead>
              <th colspan="2" class="text-center">
                <div class="btn-group justify-content-center">
                  <button type="button" id="Delete" class="btn btn-danger">Delete Cookie</button>
                  <button type="button" id="Randomize" class="btn btn-warning">Randomize Cookie</button>
                  <button type="button" id="Modify" class="btn btn-secondary">Modify Cookie</button>
                </div>
              </th>
            </thead>
          </table>
        </div>
      </div>
    </div>
    <script src="index.js"></script>

    <script>
      global.$ = require('jquery/dist/jquery');
      $(document).ready(function () {
        $("#welcomeModal").modal({
          escapeClose: false,
          clickClose: false,
          showClose: false,

          fadeDuration: 100,
          fadeDelay: 2.0
        });
        $("#loadingWelcome").show();
        $("#continueWelcome").hide();
        var viewer = $("#detailedView");
        viewer.ready(function(){
          viewer.hide();

          viewer.on('click', '#Modify', function(){
            modifyCookie();
          });

          viewer.on('click', '#Randomize', function(){
            randomizeCookie();
          });

          viewer.on('click', '#Delete', function(){
            try {
              var table = $('#cookies-dt').DataTable();
              console.log(globalRowid);
              table.row(globalRowid).remove();
              $(`#${globalRowid}`).remove();
              deleteCookie(globalCookie);
            } catch(err) {
              throw(err);
            }
          });
        });

        setTimeout(() => {
          var table = $('#cookies-dt').DataTable({
            scrollX: true,
            scrollY: true,
            select: 'single',
            ajax: function(data, callback, settings) {
              var rv = {};
              console.log("z");
              retrieveCookies(rv).then(function(){
                callback(rv);
              });
            },
            columns: [
              { data: "creation_utc" },
              { data: "host_key" },
              { data: "name" },
              { data: "path" },
              { data: "value" },
              { data: "expires_utc" },
              { data: "last_access_utc" },
              { data: "is_secure" },
              { data: "is_httponly" },
              { data: "has_expires" },
              { data: "is_persistent" },
              { data: "priority" },
              { data: "samesite" }
            ],
            initComplete: function(settings, json){
                onTableReady();
            }
          });

          function onTableReady() {
            var tracking = table.rows(function(idx, data, node){
              if (
                data["name"] === "_ga" || data["name"] === "__utma" || data["name"] === "__utmz" ||
                data["name"] === "_gcl_au" || data["name"] === "__qca" || data["name"] === "s_ecid" ||
                data["name"] === "s_vi" ||  data["name"] === "s_cc" || data["name"] === "s_sq" ||
                data["name"] === "s_fid" || data["name"] === "adcloud" || data["name"] === "_sn" ||
                data["name"] === "rat_v" || data["name"] === "_ceir"
              ) {
                return true;
              } else {
                return false;
              }
            }).every(function(rowIdx, tableNode, rowLoop){
              $(this.node()).addClass('table-danger');
            });

            resizeElements();
            $(window).on('resize', resizeElements);
            
            table.on('click', 'tr', function () {
              globalRowid = table.row(this).id();
              console.log(globalRowid);
              var rowData = table.row(this).data();
              console.log(rowData);
              var cookieID = {
                host_key: rowData["host_key"],
                name: rowData["name"],
                path: rowData["path"]
              };
              var cookie = DBI.getCookie(cookieID);
              globalCookie = cookie;
              updateDetailedView(cookie);
              $("#detailedView").show();
            });

            $("#loadingWelcome").hide();
            $.modal.close();
          };

            //$("#continueWelcome").show();
        }, 10);
        // $("#tester").click(function(){
        //   var cookie = JSON.parse('{"creation_utc": 13198689890368478,"host_key": ".fandango.com","name": "zip","value": "","path": "/","expires_utc": 13230225890000000,"is_secure": 1,"is_httponly": 0,"last_access_utc": 13198690365647604,"has_expires": 1,"is_persistent": 1,"priority": 1,"encrypted_value": "76 31 30 68 53 3e d1 61 10 31 d2 92 8f 3c 04 93 d8 eb 52","samesite": -1}');
        //   updateDetailedView(cookie);
        // });
        
      $('.dataTables_length').addClass('bs-select');
        //updateTable();

      });



    </script>

    <script>
    // var elements= document.getElementsByTagName('td');
    //   for(var i=0; i<elements.length;i++)
    //   {
    //   (elements)[i].addEventListener("click", function(){
    //     alert(this.innerHTML);
    //     console.log("hey")
    //   });
    //   }
    </script>

    
    </body>
</html>
